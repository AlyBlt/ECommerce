@using ECommerce.Web.Mvc
@using ECommerce.Web.Mvc.Models
@using ECommerce.Web.Mvc.Models.Category
@using ECommerce.Web.Mvc.Models.Home
@model ECommerce.Web.Mvc.Models.Product.ProductDetailViewModel

@{
    ViewData["Title"] = "Product Details"; 
    ViewData["PageTitle"] = ViewData["Title"];
    var isAdmin = User.IsInRole("Admin") || User.IsInRole("SystemAdmin");
    var categories = ViewBag.Categories as List<CategoryViewModel> ?? new List<CategoryViewModel>();
    var productListingViewModel = new ProductListingViewModel
    {
        Categories = categories
    };
}

<form id="csrf-holder" style="display:none;">
    @Html.AntiForgeryToken()
</form>

    @Html.Partial("_HeroSection", productListingViewModel)

<!-- Product Details -->
<section class="product-details spad">
    <div class="container">
        <div class="row">
           
            <!-- Left Column: Product Images -->
            <div class="col-lg-6 col-md-6">
                <div class="product__details__pic">
                    <div class="product__details__pic__item">
                        <img class="product__details__pic__item--large"
                             src="@ImageHelper.GetUrl(Model.ImageUrl)"
                             alt="@Model.Name">
                    </div>
                </div>
            </div>

            <!-- Right Column: Product Info & Add to Cart -->
            <div class="col-lg-6 col-md-6">
                <div class="product__details__text">
                    @if (!Model.Enabled)
                    {
                        <div class="alert alert-warning">
                            This product is currently not available for sale.
                        </div>
                    }
                    <h3 style="font-weight: normal;">@Model.Name</h3>

                    <!-- Product Rating -->
                    <div class="product__details__rating" style="font-size: 18px;">
                        @for (int i = 0; i < 5; i++)
                        {
                            if (i < Math.Floor((double)Model.Rating))
                            {
                                <i class="fa fa-star"></i>
                            }
                            else if (i < Model.Rating)
                            {
                                <i class="fa fa-star-half-o"></i>
                            }
                            else
                            {
                                <i class="fa fa-star-o"></i>
                            }
                        }
                        <span>(@Model.ReviewCount reviews)</span>
                    </div>

                    <!-- Product Price -->
                    <div class="product__details__price">
                        <!-- Price Formatting with Decimal -->
                        $@Model.Price.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)
                        @if (Model.IsOnSale)
                        {
                            <!-- Old Price Formatting with Decimal -->
                            <del>$@Model.OldPrice?.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)</del>
                        }
                    </div>

                    <p>@Model.Description</p>

                    <!-- Quantity and Add to Cart -->
                    <div class="product__details__quantity">
                        <div class="quantity">
                            <div class="pro-qty">
                                <input type="text" value="1">
                            </div>
                        </div>
                    </div>

                    @if (isAdmin)
                     {
                        <a href="javascript:void(0);" style="cursor: not-allowed; opacity: 0.7;" title="Admins cannot add favorites" data-product-id="@Model.Id">
                        <i class="fa fa-heart primary-btn"></i>
                    </a>
                     }
                     else
                    {
                        <a href="#" class="favorite-btn" data-product-id="@Model.Id">
                            <i class="fa fa-heart primary-btn"></i>
                        </a>
                    }

                    <form id="add-to-cart-form" method="post" action="@Url.Action("AddProduct", "Cart")">
                        <input type="hidden" name="productId" value="@Model.Id" />
                        <input type="hidden" name="name" value="@Model.Name" />
                        <input type="hidden" name="price" value="@Model.Price" />
                        <input type="hidden" name="imageUrl" value="@ImageHelper.GetUrl(Model.ImageUrl)" />
                        <input type="hidden" name="quantity" value="1" />
                        @if (!Model.Enabled)
                        {
                          <button class="primary-btn" disabled
                           style="opacity:0.5; cursor:not-allowed;">
                                NOT AVAILABLE
                          </button>
                        }
                        else
                       {
                            @if (isAdmin)
                             {
                                <button type="submit" class="primary-btn" style="opacity:0.5; cursor:not-allowed;" title="Admins cannot shop">ADD TO CART</button>
                             }
                             else
                             {
                                <button type="submit" class="primary-btn">ADD TO CART</button>
                             }
                        }
                    </form>
                   

                    <ul>
                        <li><b>Availability</b> <span>@Model.Availability</span></li>
                        <li>
                            <b>Share on</b>
                            <div class="share">
                                <a href="#"><i class="fa fa-facebook"></i></a>
                                <a href="#"><i class="fa fa-twitter"></i></a>
                                <a href="#"><i class="fa fa-instagram"></i></a>
                                <a href="#"><i class="fa fa-pinterest"></i></a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Product Comments -->
<section class="product-comments spad">
    <div class="container">
        <h4 class="mb-4">Comments</h4>

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger">@TempData["Error"]</div>
            TempData.Clear();
        }


        <!-- Success Message -->
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @TempData["Success"]
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        }

        <!-- Add Comment Form -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                @if (User.IsInRole("Buyer") || User.IsInRole("Seller"))
                {
                    if (ViewBag.CanComment == true)
                    {
                    <form asp-action="Comment" asp-controller="Product" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="productId" value="@Model.Id" />
                        <input type="hidden" name="UserName" value="@User.Identity.Name" />
                        <input type="hidden" name="ProductName" value="@Model.Name" />

                        <div class="form-group mb-3">
                            <label for="text">Your Comment</label>
                            <textarea class="form-control" name="Text" id="text" rows="3" placeholder="Write your comment..." required></textarea>
                        </div>

                        <div class="form-group mb-3">
                            <label for="rating">Rating</label>
                            <select class="form-control" name="Rating" id="rating" required>
                                <option value="1">1 Star</option>
                                <option value="2">2 Stars</option>
                                <option value="3">3 Stars</option>
                                <option value="4">4 Stars</option>
                                <option value="5">5 Stars</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary">Submit Comment</button>

                    </form>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="fa fa-lock"></i> <strong>Only verified buyers can leave a review.</strong>
                            You must purchase this product to share your experience.
                        </div>
                    }
                }
                else if (isAdmin)
                {
                    <p>As an admin, you are not authorized to write comment here.</p>
                }
                else
                {
                    <p>Please <a href="/account/login?returnUrl=@Url.Action("ProductDetail", "Home", new { id = Model.Id })">login</a> to comment.</p>
                }
            </div>
        </div>
        <!-- Existing Comments -->
        <div class="comments-list">
            @if (Model.Comments != null && Model.Comments.Any(c => c.IsApproved))
            {
                @foreach (var comment in Model.Comments.Where(c => c.IsApproved))
                {
                    <div class="card mb-3 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>@comment.UserName</strong>
                                <span>
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= comment.Rating)
                                        {
                                            <i class="fa fa-star text-warning"></i>
                                        }
                                        else
                                        {
                                            <i class="fa fa-star-o text-warning"></i>
                                        }
                                    }
                                </span>
                            </div>
                            <p>@comment.Text</p>
                        </div>
                    </div>
                }
            }
            else
            {
                <p>No comments yet. Be the first to comment!</p>
            }
        </div>
    </div>
</section>

<!-- Related Products -->
<section class="related-product">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="section-title related__product__title">
                    <h2>Related Products</h2>
                </div>
            </div>
        </div>
        <div class="row">
            @foreach (var product in Model.RelatedProducts)
            {
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="product__item">
                        <div class="product__item__pic set-bg" data-setbg="@ImageHelper.GetUrl(product.ImageUrl)">
                            <ul class="product__item__pic__hover">
                                @if (isAdmin)
                                {
                                 <li>
                                        <a href="javascript:void(0);" style="cursor: not-allowed; opacity: 0.5;" title="Admins cannot add favorites" class="admin-disabled" data-product-id="@product.Id">
                                        <i class="fa fa-heart"></i>
                                    </a>
                                </li>
                                     <li><a href="javascript:void(0);" style="cursor: not-allowed; opacity: 0.5;" class="admin-disabled"><i class="fa fa-retweet"></i></a></li>
                                }
                                else
                                {
                                    <li>
                                        <a href="#" class="favorite-btn" data-product-id="@product.Id">
                                            <i class="fa fa-heart"></i>
                                        </a>
                                    </li>

                                    <li><a href="#"><i class="fa fa-retweet"></i></a></li>
                                }
                                <li>
                                    @if (!product.IsActive)
                                    {
                                        <button class="primary-btn" disabled style="opacity:0.5;">
                                            NOT AVAILABLE
                                        </button>
                                    }
                                    else
                                    {
                                        @if (isAdmin)
                                        {
                                            <a href="javascript:void(0);" class="admin-disabled"
                                               style="cursor: not-allowed; opacity: 0.5;"
                                               title="Admins cannot add products to cart" data-product-id="@product.Id"
                                           data-is-active="@product.IsActive.ToString().ToLower()"
                                           data-name="@product.Name"
                                           data-price="@product.Price"
                                           data-image="@ImageHelper.GetUrl(product.ImageUrl)" >
                                            <i class="fa fa-shopping-cart"></i>
                                        </a>
                                        }
                                        else
                                        {
                                            <a href="#" class="add-to-cart-btn" data-product-id="@product.Id"
                                               data-is-active="@product.IsActive.ToString().ToLower()"
                                               data-name="@product.Name"
                                               data-price="@product.Price"
                                               data-image="@ImageHelper.GetUrl(product.ImageUrl)">
                                                <i class="fa fa-shopping-cart"></i>
                                            </a>
                                        }
                                    }
                                </li>
                            </ul>
                        </div>
                        <div class="product__item__text">
                            <h6>
                                <a href="@Url.Action("ProductDetail", "Home", new { id = product.Id })" style="font-size: 18px;">
                                    @product.Name
                                </a>
                            </h6>

                            <!-- Rating stars ve review count -->
                            <div class="rating-area">
                                <span class="stars">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if ((product.Rating ?? 0) >= i)
                                        {
                                            <i class="fa fa-star"></i>
                                        }
                                        else
                                        {
                                            <i class="fa fa-star-o"></i>
                                        }
                                    }
                                </span>
                                <span class="review-count">(@(product.ReviewCount ?? 0) reviews)</span>
                            </div>
                           
                            <h5>
                                <!-- Related Product Price Formatting -->
                                $@product.Price.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)
                                @if (product.IsOnSale)
                                {
                                    <del>$@product.OldPrice?.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)</del>
                                }
                            </h5>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</section>

<style>
    .product__details__pic__item--large {
        width: 100%;
        height: 400px; 
        object-fit: cover; /* Fotoğrafı kapsayıcıya sığdırırken kesebilir */
    }

    .product__details__price {
        color: black !important; 
        
    }
    .product__details__rating span {
        color: black !important; 
        font-weight: normal; 
    }

  
/* Favori ikonunun üzerine gelindiğinde (hover)
        .product__details__text .favorite-btn:hover {
        opacity: 0.8; /* İkon biraz daha şeffaf hale gelir */
         }
    .product__details__text .addCart:hover {
        opacity: 0.8; /* İkon biraz daha şeffaf hale gelir */
    }

    .rating-area .stars {
        color: #FFD700;
       
    }

    .product-comments .card {
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }

    .product-comments .card-body {
        padding: 1rem 1.5rem;
    }

    .product-comments .fa-star,
    .product-comments .fa-star-o {
        margin-right: 2px;
    }

    .product-comments h4 {
        font-weight: 600;
    }

    .product-comments .comments-list p {
        margin: 0;
    }

</style>


@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var buttons = document.querySelectorAll(".favorite-btn");

            buttons.forEach(function (btn) {
                btn.addEventListener("click", function (e) {
                    e.preventDefault();

                    var productId = this.getAttribute("data-product-id");

                    fetch("/Favorites/Add", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: "productId=" + productId
                    })
                        .then(response => {
                            if (response.ok) {
                                var countSpan = document.getElementById("header-favorites-count");
                                if (countSpan) {
                                    countSpan.textContent = parseInt(countSpan.textContent || "0") + 1;
                                }
                                alert("Product added to favorites!");
                            } else {
                                alert("Failed to add favorite");
                            }
                        })
                        .catch(err => console.error(err));
                });
            });
        });
       

        

            document.addEventListener("DOMContentLoaded", function () {
            var addToCartForm = document.getElementById("add-to-cart-form");

            if (addToCartForm) {
                addToCartForm.addEventListener("submit", function (e) {
                    e.preventDefault();

                    // 1. Kullanıcının arayüzde değiştirdiği gerçek miktarı al
                    var displayQuantity = document.querySelector(".pro-qty input").value;
                    // 2. Formun içindeki gizli (hidden) inputu bu yeni değerle güncelle
                    var hiddenQuantityInput = this.querySelector("input[name='quantity']");
                    hiddenQuantityInput.value = displayQuantity;
                  
                    var productId = this.querySelector("input[name='productId']").value;
                    var name = this.querySelector("input[name='name']").value;
                    var price = this.querySelector("input[name='price']").value;
                    var imageUrl = this.querySelector("input[name='imageUrl']").value;
                    var quantity = hiddenQuantityInput.value; // Güncel değer

                    fetch("@Url.Action("AddProduct", "Cart")", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "RequestVerificationToken": document.querySelector("#csrf-holder input").value
                        },
                        body: `productId=${productId}&name=${encodeURIComponent(name)}&price=${price}&imageUrl=${encodeURIComponent(imageUrl)}&quantity=${quantity}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("Product added to cart!");
                            var cartCountSpan = document.getElementById("cart-count");
                            if (cartCountSpan) {
                                cartCountSpan.textContent = data.cartCount;
                            }
                            // Header cart total güncelle
                           const cartTotalSpan = document.getElementById("cart-total");
                           if(cartTotalSpan){
                           cartTotalSpan.textContent = "$ " + data.cartTotal.toFixed(2);
                           }
                           
                        } else {
                            alert("Failed to add product to cart.");
                        }
                    })
                    .catch(error => console.error("Error adding product to cart:", error));
                });
            }
        });


        //Related Product add

                document.addEventListener("DOMContentLoaded", function () {
            var addToCartButtons = document.querySelectorAll(".add-to-cart-btn");

            addToCartButtons.forEach(function (btn) {
                btn.addEventListener("click", function (e) {
                    e.preventDefault();

                     
                      var productId = this.dataset.productId;
                      var name = this.dataset.name;
                      var price = this.dataset.price;
                      var imageUrl = this.dataset.image;
                      var quantity = this.dataset.quantity || 1;

                    fetch("@Url.Action("AddProduct", "Cart")", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "RequestVerificationToken": document.querySelector("#csrf-holder input").value
                        },
                         body: `productId=${productId}&name=${encodeURIComponent(name)}&price=${price}&imageUrl=${encodeURIComponent(imageUrl)}&quantity=${quantity}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("Product added to cart!");
                            var cartCountSpan = document.getElementById("cart-count");
                            if (cartCountSpan) {
                                cartCountSpan.textContent = data.cartCount;
                            }
                                    // Header cart total güncelle
                         const cartTotalSpan = document.getElementById("cart-total");
                        if(cartTotalSpan){
                        cartTotalSpan.textContent = "$ " + data.cartTotal.toFixed(2);
                        }
                        } else {
                            alert("Failed to add product to cart.");
                        }
                    })
                    .catch(error => console.error("Error adding product to cart:", error));
                });
            });
        });
    </script>
        }