@model List<ECommerce.Web.Mvc.Models.Favorite.FavoriteItemViewModel>
@{
    ViewData["Title"] = "My Favorites";
    var isAdmin = User.IsInRole("Admin");
    var isAuthenticated = User.Identity?.IsAuthenticated ?? false;
    var isBuyerOrSeller = User.IsInRole("Buyer") || User.IsInRole("Seller");
}
@if (isAdmin)
{
    <div class="alert alert-danger">
        You are not authorized to view or modify the favorites. Please proceed to the admin dashboard.
    </div>
}
else
{
<section class="shoping-cart spad">
    <div class="container">

    @if (TempData["Error"] != null)
    {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["Error"]
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
    }
    @if (TempData["Success"] != null || TempData["Message"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @(TempData["Success"] ?? TempData["Message"])
            <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
        </div>
    }


   
     <h2 class="mb-4">My Favorites</h2>

        @if (Model.Any())
        {
            <div class="shoping__cart__table">
                <table>
                    <thead>
                        <tr>
                            <th class="shoping__product">Product</th>
                            <th>Price</th>
                            <th>Action</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td class="shoping__cart__item d-flex align-items-center">
                                    <img src="@(!string.IsNullOrEmpty(item.ImageUrl) ? Url.Content(item.ImageUrl) : Url.Content("~/img/product/default.jpg"))"
                                         alt="@item.Name"
                                         class="me-3"
                                         style="width:70px; height:70px; object-fit:cover;" />
                                    <h5 class="m-0">@item.Name</h5>
                                </td>

                                <td class="shoping__cart__price">
                                    $ @item.Price.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)
                                </td>

                                <td class="shoping__cart__item__close d-flex flex-column">
                                    <!-- Remove -->
                                    <form asp-controller="Favorites"
                                          asp-action="Remove"
                                          method="post" class="mb-1">
                                        <input type="hidden" name="productId" value="@item.ProductId" />
                                        <button type="submit" class="primary-btn btn-sm">
                                            Remove
                                        </button>
                                    </form>

                                    <!-- Add to Cart -->
                                    <form class="add-to-cart-form" data-productid="@item.ProductId" data-name="@item.Name" data-price="@item.Price" data-imageurl="@item.ImageUrl" data-quantity="1">
                                        @Html.AntiForgeryToken()
                                        <button type="button" class="primary-btn btn-sm add-to-cart-btn">
                                            Add to Cart
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="shoping__cart__btns mt-4 d-flex justify-content-between">

                <!-- BACK -->
                <a asp-controller="Home" asp-action="Listing" class="primary-btn cart-btn">
                    ← Back to Shop
                </a>

                <!-- CLEAR FAVORITES -->
                <form asp-controller="Favorites" asp-action="ClearFavorites" method="post" class="go-to-cart-form">
                    <button type="submit" class="primary-btn cart-btn">Clear Favorites</button>
                </form>

                <!-- GO TO CART -->
                <a asp-controller="Cart" asp-action="Index" class="primary-btn cart-btn">
                    Go to Cart →
                </a>

            </div>
        }
        else
        {
            <p class="text-muted">Your favorites list is empty.</p>

            <a asp-controller="Home" asp-action="Listing" class="primary-btn mt-3">
                ← Back to Shop
            </a>
        }

    </div>
</section>
}

@section Styles {
    <style>
        .go-to-cart-form button {
            border: none;
        }

        .shoping__cart__table table {
            font-size: 0.9rem;
        }

        .shoping__cart__item__close .primary-btn {
            padding: 4px 10px;
            font-size: 0.85rem;
        }
    </style>
}




@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
        $(document).ready(function () {

            $('.add-to-cart-btn').click(function (e) {
                e.preventDefault();

                var form = $(this).closest('form');

                var productId = form.data('productid');
                var name = form.data('name');
                var price = form.data('price');
                var imageUrl = form.data('imageurl');
                var quantity = form.data('quantity');
                var token = form.find('input[name="__RequestVerificationToken"]').val();

                $.ajax({
                    url: '/Cart/AddProduct',
                    type: 'POST',
                    data: {
                        productId: productId,
                        name: name,
                        price: price,
                        imageUrl: imageUrl,
                        quantity: quantity,
                        __RequestVerificationToken: token
                    },
                    success: function (res) {

                        if (res.success) {
                            // HEADER UPDATE
                            $('#cart-count').text(res.cartCount);
                            $('#cart-total').text(res.cartTotal.toFixed(2) + ' $');

                            alert(res.message);
                        }
                    },
                    error: function () {
                        alert('Something went wrong!');
                    }
                });
            });

        });
    </script>
}